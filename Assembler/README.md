# Cicada-16 Assembler (`casm`)

This directory contains the complete source code for `casm`, the official assembler for the Cicada-16 fantasy console. This program is responsible for translating human-readable Cicada-16 assembly language into the binary machine code that the console can execute.

It is a command-line tool written in Rust that takes a source `.asm` file and outputs a `.bin` file representing the final cartridge ROM image.

## Architecture

`casm` is a classic **two-pass assembler**. This design is crucial for handling forward references, where a label is used before it is defined (e.g., jumping forward to a label that appears later in the code).

- **Pass 1**: The assembler reads through the entire source code to build a **symbol table**. It calculates the memory address for every label it encounters. To do this, it must know the size of every instruction, but it doesn't generate the full machine code yet.

- **Pass 2**: The assembler reads the source code a second time. Now, with the completed symbol table, it can translate each instruction and its operands into their final binary representation, substituting the memory addresses for any labels it finds.

## Code Structure

The assembler's source code is organized into several modules, each with a distinct responsibility.

- `main.rs`

  - The entry point for the application. It uses the `clap` crate to parse command-line arguments and orchestrates the entire assembly process from file input to final binary output.

- `grammar.pest`

  - This file defines the formal grammar of the Cicada-16 assembly language using the `pest` parser generator. It is the blueprint for what constitutes valid syntax, from instructions and operands to labels and comments.

- `ast.rs`

  - Defines the **Abstract Syntax Tree (AST)**. These are the core Rust `struct`s and `enum`s (like `Instruction`, `Operand`, and `AssemblyLine`) that represent the parsed source code in a strongly-typed, hierarchical structure.

- `errors.rs`

  - Defines the custom error types used throughout the assembler for clear and specific error reporting during parsing and assembly.

- `parser/`

  - This module is responsible for the first major step: converting the raw source text into the AST.
  - `mod.rs`: Contains the main `parse_source` function which drives the `pest` parser.
  - `ast_builder/`: This sub-module walks the raw parse tree generated by `pest` and meticulously constructs the AST nodes defined in `ast.rs`.

- `assembler/`
  - This is the core of the assembler, where the AST is transformed into machine code.
  - `mod.rs`: Implements the two-pass logic. `build_symbol_table` (Pass 1) and `generate_bytecode` (Pass 2).
  - `symbol_table.rs`: Defines the data structures for the symbol table, which maps label strings to their calculated addresses.
  - `encoder/`: This module handles the final translation from a single AST `Instruction` node into its corresponding sequence of bytes.

## Compatability

**cicasm_v0.1.11** compatible with **HardwareSpec_v0.3.11**
